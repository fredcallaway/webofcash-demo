// Generated by CoffeeScript 2.2.2
// coffeelint: disable=max_line_length, indentation

// tell coffeescript about global variables
var DASHBOARD_COLS, EXPERIMENT, N_TEST, N_TRAIN, N_TRAIN_REWARD, askWhatDemo, data, demoTask, radio, runDemo, showDemoTrials, showHuman, showHumanDashboard, showModel, showModelDashboard, showTask;

EXPERIMENT = EXPERIMENT;

N_TRAIN = N_TRAIN;

N_TEST = N_TEST;

N_TRAIN_REWARD = N_TRAIN_REWARD;

radio = function(group, val, label, attrs = "") {
  return `<input type="radio" id="${val}" name="${group}" value="${val}" ${attrs}>\n<label for="${val}">${label}</label>&nbsp;&nbsp;&nbsp;`;
};

askWhatDemo = function() {
  var buttons, click, top;
  top = "<h1>Mouselab-MDP demonstration</h1>\n\n<p>Which experiment/condition would you like to view?";
  top += "<p><strong>Experiment 1:&nbsp;&nbsp;&nbsp;</strong>";
  top += radio('exp', "1-constant", "constant", "checked");
  top += "<p><strong>Experiment 2:&nbsp;&nbsp;&nbsp;</strong>";
  top += radio('exp', "2-decreasing", "decreasing");
  top += radio('exp', "2-constant", "constant");
  top += radio('exp', "2-increasing", "increasing");
  top += "<p><strong>Experiment 3:&nbsp;&nbsp;&nbsp;</strong>";
  top += radio('exp', "3-decreasing", "decreasing");
  top += radio('exp', "3-constant", "constant");
  top += radio('exp', "3-increasing", "increasing");
  top += "<p><strong>Experiment 4:&nbsp;&nbsp;&nbsp;</strong>";
  top += '<a href="http://roadtriptask.herokuapp.com/exp?hitId=demo&assignmentId=demo&workerId=demo&mode=debug"><strong>click here</strong></a>';
  top += ' (task demo only)';
  top += "<p>\nYou can do the experiment yourself or you can watch playbacks\nof our participants or the optimal model performing the task.";
  $('#demo-landing').html(top);
  $('#jspsych-target').empty();
  buttons = $('<div/>').css({
    'text-align': 'center',
    'margin-top': '20px'
  });
  buttons.appendTo($('#demo-landing'));
  click = function(show) {
    var exp, variance;
    [exp, variance] = $('input[name="exp"]:checked').val().split('-');
    EXPERIMENT = parseInt(exp);
    window.history.pushState("", "", `/?exp=${exp}&variance=${variance}&show=${show}`);
    return runDemo();
  };
  $('<button/>', {
    class: 'btn btn-primary ',
    text: 'Do Task',
    click: function() {
      return click('task');
    }
  }).appendTo(buttons);
  $('<button/>', {
    class: 'btn btn-primary ',
    text: 'Watch Participants',
    click: function() {
      return click('human');
    }
  }).appendTo(buttons);
  return $('<button/>', {
    class: 'btn btn-primary ',
    text: 'Watch Optimal Model',
    click: function() {
      return click('model');
    }
  }).appendTo(buttons);
};


// $('<button/>',
//   class: 'btn btn-primary '
//   text: 'Watch Model Simulations'
//   click: -> click('model')
// ).appendTo buttons
data = null;

runDemo = function() {
  var show;
  console.log('runDemo');
  show = getSearchParam('show');
  if (show == null) {
    return askWhatDemo();
  } else {
    switch (show) {
      case 'task':
        return showTask();
      case 'human':
        return showHuman();
      case 'model':
        return showModel();
    }
  }
};

showTask = function() {
  var buttons, click, length;
  console.log('showTask', length);
  length = getSearchParam('length');
  if (length === 'short') {
    N_TRAIN = 1;
    N_TRAIN_REWARD = 3;
    N_TEST = 5;
    return loadExperiment();
  } else if (length === 'full') {
    return loadExperiment();
  } else {
    $('#demo-landing').html("<h1>Web of Cash task demo</h1>\n<br>Would you like to do an abbreviated version of the experiment (fewer trials in each section)\n or the full-length version, exactly as given to participants?");
    buttons = $('<div/>').css({
      'text-align': 'center',
      'margin-top': '20px'
    });
    buttons.appendTo($('#demo-landing'));
    click = function(length) {
      if (length === 'skip') {
        window.history.pushState("", "", location.search + "&length=full&skip=8");
      } else {
        window.history.pushState("", "", location.search + `&length=${length}`);
      }
      return showTask();
    };
    $('<button/>', {
      class: 'btn btn-primary ',
      text: 'Shortened',
      click: function() {
        return click('short');
      }
    }).appendTo(buttons);
    $('<button/>', {
      class: 'btn btn-primary ',
      text: 'Full length',
      click: function() {
        return click('full');
      }
    }).appendTo(buttons);
    return $('<button/>', {
      class: 'btn btn-primary ',
      text: 'Skip Instructions',
      click: function() {
        return click('skip');
      }
    }).appendTo(buttons);
  }
};

showHuman = function() {
  var trials, wid;
  wid = getSearchParam('participant');
  if (wid != null) {
    $('#demo-landing').hide();
    $('#load-icon').show();
    wid = getSearchParam('participant');
    trials = loadJson(`static/json/demo/${getSearchParam('exp')}/human/${wid}.json`);
    return showDemoTrials(trials);
  } else {
    return showHumanDashboard();
  }
};

showDemoTrials = function(trials) {
  var PARAMS, STRUCTURE, trial_idx, watch;
  trial_idx = parseInt(getSearchParam('trial')) - 1 || 0;
  PARAMS = makeParams();
  STRUCTURE = loadJson(`static/json/structure/${PARAMS.branching}.json`);
  watch = new Block({
    type: 'mouselab-mdp',
    playerImage: 'static/images/spider.png',
    lowerMessage: 'Move with the arrow keys.',
    clickDelay: 0,
    expandOnly: PARAMS.expandOnly,
    _init: function() {
      _.extend(this, STRUCTURE);
      return this.trialCount = trial_idx;
    },
    // minTime: 7
    blockName: 'test',
    stateDisplay: 'click',
    stateClickCost: PARAMS.inspectCost,
    timeline: trials.slice((trial_idx)),
    rightMessage: "&nbsp;",
    leftMessage: function() {
      var search, trial;
      trial = watch.trialCount + 1;
      search = location.search.split('&trial')[0];
      window.history.pushState("", "", `/${search}&trial=${trial}`);
      return `Round ${trial}/${trials.length}`;
    },
    startScore: 50
  });
  return jsPsych.init({
    display_element: $('#jspsych-target'),
    timeline: [watch],
    // show_progress_bar: true
    on_finish: function() {
      window.history.pushState("", "", search);
      return runDemo();
    }
  });
};

showHumanDashboard = function() {
  var WATCH, col, header, i, len, table, tbl, top;
  $('#demo-landing').show();
  $('#jspsych-target').empty();
  top = "<h1>Human data playbacks</h1>\nClick on one of the buttons below to view the behavior of our\nparticipants. Note that the URL will be updated as you progress through\nthe experiment, so you can create a link to the current trial by copying\nthe text in the search bar.\n\n<br><br>";
  $('#demo-landing').html(top);
  $('#demo-landing').append($('<button/>', {
    class: 'btn btn-primary',
    text: 'Back',
    style: 'margin-bottom: 10px',
    click: function() {
      window.history.pushState("", "", "/");
      return runDemo();
    }
  }));
  // $('#demo-landing').css
  //   width: 'px'
  WATCH = true;
  table = loadJson(`static/json/demo/${getSearchParam('exp')}/human/table-${getSearchParam('variance')}.json`);
  tbl = $("<table/>").addClass('table');
  header = $("<tr>").appendTo(tbl);
  for (i = 0, len = DASHBOARD_COLS.length; i < len; i++) {
    col = DASHBOARD_COLS[i];
    $('<td/>').css("font-weight", "Bold").text(col).appendTo(header);
  }
  _(table).forEach(function(d) {
    var j, len1, ref, row;
    row = $('<tr/>').appendTo(tbl);
    ref = ['wid', 'variance', 'score', 'clicks'];
    // 'optimal_cost', 'optimal_nll', 'bestfirst_nll'
    for (j = 0, len1 = ref.length; j < len1; j++) {
      col = ref[j];
      $('<td/>').text(d[col]).appendTo(row);
    }
    return row.append($('<button/>', {
      class: 'btn btn-primary ',
      text: 'Go',
      click: function() {
        var search;
        search = location.search + `&participant=${d.wid}`;
        window.history.pushState("", "", search);
        return showHuman();
      }
    }));
  });
  return tbl.appendTo($('#demo-landing'));
};

showModel = function() {
  var model, trials;
  console.log('showModel');
  model = getSearchParam('model');
  if (model != null) {
    $('#demo-landing').hide();
    $('#load-icon').show();
    trials = loadJson(`static/json/demo/${getSearchParam('exp')}/optimal/${model}.json`);
    return showDemoTrials(trials);
  } else {
    return showModelDashboard();
  }
};

demoTask = function() {
  var buttons, top;
  switch (SHOW) {
    case 'short':
      N_TRAIN = 1;
      N_TEST = 5;
      return initializeExperiment();
    case 'full':
    case 'test':
    case 'debug':
    case 'quiz':
    case 'comprehension':
      return initializeExperiment();
    default:
      top = "<h1>Web of Cash Experiment Demo</h1>\nPlease select one of the buttons below to do the full experiment,\na version of the experiment with fewer trials,\nor just the task (skipping instructions).";
      $('#demo-landing').html(top);
      buttons = $('<div/>').css({
        'text-align': 'center',
        'margin-top': '20px'
      });
      buttons.appendTo($('#demo-landing'));
      $('<button/>', {
        class: 'btn btn-primary',
        text: 'Full Length',
        click: function() {
          var SHOW;
          window.history.pushState("", "", "/?show=full");
          SHOW = "full";
          return initializeExperiment();
        }
      }).appendTo(buttons);
      $('<button/>', {
        class: 'btn btn-primary ',
        text: 'Shortened',
        click: function() {
          var SHOW;
          N_TRAIN = 1;
          N_TEST = 5;
          window.history.pushState("", "", "/?show=short");
          SHOW = "short";
          return initializeExperiment();
        }
      }).appendTo(buttons);
      return $('<button/>', {
        class: 'btn btn-primary ',
        text: 'Test Only',
        click: function() {
          var DEMO, SHOW;
          window.history.pushState("", "", "/?show=test");
          DEMO = true;
          SHOW = "test";
          return initializeExperiment();
        }
      }).appendTo(buttons);
  }
};

DASHBOARD_COLS = [
  'Participant ID',
  'Variance',
  'Average Score',
  'Average Clicks',
  // 'MLE Cost'
  // 'Optimal NLL'
  // 'BestFirst NLL'
  'Click To Watch'
];

showModelDashboard = function() {
  var WATCH, col, header, i, len, ref, table, tbl, top;
  $('#demo-landing').show();
  console.log('showModelDashboard');
  top = markdown("<h1>Web of Cash Visualization Dashboard</h1>\nClick on one of the buttons below to view model simulations.\n<br><br>");
  $('#demo-landing').html(top);
  $('#demo-landing').append($('<button/>', {
    class: 'btn btn-primary',
    text: 'Back',
    style: 'margin-bottom: 10px',
    click: function() {
      window.history.pushState("", "", "/");
      return runDemo();
    }
  }));
  WATCH = true;
  table = loadJson(`static/json/demo/${getSearchParam('exp')}/optimal/table-${getSearchParam('variance')}.json`);
  tbl = $("<table/>").addClass('table');
  tbl.appendTo($('#demo-landing'));
  header = $("<tr>").appendTo(tbl);
  ref = ['Cost', 'Average Score', 'Average Clicks', 'Click to Watch'];
  for (i = 0, len = ref.length; i < len; i++) {
    col = ref[i];
    $('<td/>').css("font-weight", "Bold").text(col).appendTo(header);
  }
  return _(table).forEach(function(d) {
    var j, len1, ref1, row;
    row = $('<tr/>').appendTo(tbl);
    ref1 = ['cost', 'score', 'clicks'];
    // 'optimal_cost', 'optimal_nll', 'bestfirst_nll'
    for (j = 0, len1 = ref1.length; j < len1; j++) {
      col = ref1[j];
      $('<td/>').text(d[col]).appendTo(row);
    }
    return row.append($('<button/>', {
      class: 'btn btn-primary ',
      text: 'Go',
      click: function() {
        var search;
        search = location.search + `&model=${d.name}`;
        window.history.pushState("", "", search);
        return showModel();
      }
    }));
  });
};
